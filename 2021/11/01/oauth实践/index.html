<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Oauthå®è·µ | ä¸€ä½•æœ‰å°”çš„åšå®¢</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="shortcut icon" href="/blog/favicon.ico">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/app_icon/app_icon48.jpeg">
    <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="
ç®€ä»‹

oauthæ˜¯ä¸€ç§è®¤è¯å’ŒæˆæƒæŠ€æœ¯ï¼Œå¸¸ç”¨äºç¬¬ä¸‰æ–¹ç™»å½•ï¼Œæ¯”å¦‚githubç™»å½•ï¼Œä¸‹é¢éƒ½æ˜¯ä»¥githubä¸ºä¾‹è¿›è¡Œè®²è§£

æµç¨‹

ç”¨æˆ·è¯·æ±‚ä½ çš„æœåŠ¡å™¨æŸä¸ªè·¯ç”±æ¯”å¦‚/login
æœåŠ¡ç«¯redirectæµè§ˆå™¨åˆ°æˆæƒé¡µ
`https://github.com/login/oauth/authorize?responsetype=code&clientid=&redirect_u ...">
    <meta name="baidu-site-verification" content="41GlPEeYTk">
    <meta name="keywords" content="vuepress, blog, ä¸€ä½•æœ‰å°”">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/images/app_icon/app_icon48.jpeg">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.db20579b.css" as="style"><link rel="preload" href="/blog/assets/js/app.c616dceb.js" as="script"><link rel="preload" href="/blog/assets/js/6.b5d332af.js" as="script"><link rel="preload" href="/blog/assets/js/3.749e8baa.js" as="script"><link rel="preload" href="/blog/assets/js/21.84e35001.js" as="script"><link rel="preload" href="/blog/assets/js/8.050f5748.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.aa1dac21.js"><link rel="prefetch" href="/blog/assets/js/11.70c977ba.js"><link rel="prefetch" href="/blog/assets/js/12.bca8c580.js"><link rel="prefetch" href="/blog/assets/js/13.b618ec97.js"><link rel="prefetch" href="/blog/assets/js/14.80ae0e92.js"><link rel="prefetch" href="/blog/assets/js/15.1e8d5c02.js"><link rel="prefetch" href="/blog/assets/js/16.9fcef108.js"><link rel="prefetch" href="/blog/assets/js/17.60290ab1.js"><link rel="prefetch" href="/blog/assets/js/18.bd9b53f4.js"><link rel="prefetch" href="/blog/assets/js/19.bf170d35.js"><link rel="prefetch" href="/blog/assets/js/20.76d2073a.js"><link rel="prefetch" href="/blog/assets/js/22.9a77eca9.js"><link rel="prefetch" href="/blog/assets/js/23.eee85973.js"><link rel="prefetch" href="/blog/assets/js/24.af56bcfb.js"><link rel="prefetch" href="/blog/assets/js/25.b9c14c5d.js"><link rel="prefetch" href="/blog/assets/js/26.31632e5f.js"><link rel="prefetch" href="/blog/assets/js/27.b62c171d.js"><link rel="prefetch" href="/blog/assets/js/28.c6fdb267.js"><link rel="prefetch" href="/blog/assets/js/29.c3073e06.js"><link rel="prefetch" href="/blog/assets/js/30.8fd564e6.js"><link rel="prefetch" href="/blog/assets/js/31.2d770bc9.js"><link rel="prefetch" href="/blog/assets/js/32.a63a63d2.js"><link rel="prefetch" href="/blog/assets/js/33.8bc5dfef.js"><link rel="prefetch" href="/blog/assets/js/34.768a88f4.js"><link rel="prefetch" href="/blog/assets/js/35.07c0faed.js"><link rel="prefetch" href="/blog/assets/js/36.91bb844e.js"><link rel="prefetch" href="/blog/assets/js/4.c95f156b.js"><link rel="prefetch" href="/blog/assets/js/5.1b5f68e5.js"><link rel="prefetch" href="/blog/assets/js/7.833de25a.js"><link rel="prefetch" href="/blog/assets/js/9.5e1c757e.js"><link rel="prefetch" href="/blog/assets/js/vuejs-paginate.c4247c5c.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.db20579b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/blog/" class="nav-link home-link">ä¸€ä½•æœ‰å°”çš„åšå®¢ </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/blog/" class="nav-link">Home</a></li><li class="nav-item"><a href="/blog/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/blog/" class="nav-link mobile-home-link">ä¸€ä½•æœ‰å°”çš„åšå®¢ </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/blog/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/blog/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2021-11-01T00:00:00.000Z">
      Mon Nov 01 2021
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/blog/tag/oauth" data-v-42ccfcd5><span data-v-42ccfcd5>oauth</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/blog/tag/fastify" data-v-42ccfcd5><span data-v-42ccfcd5>fastify</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h1 id="oauthå®è·µ"><a href="#oauthå®è·µ" class="header-anchor">#</a> Oauthå®è·µ</h1> <h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="header-anchor">#</a> ç®€ä»‹</h2> <p>oauthæ˜¯ä¸€ç§è®¤è¯å’ŒæˆæƒæŠ€æœ¯ï¼Œå¸¸ç”¨äºç¬¬ä¸‰æ–¹ç™»å½•ï¼Œæ¯”å¦‚githubç™»å½•ï¼Œä¸‹é¢éƒ½æ˜¯ä»¥githubä¸ºä¾‹è¿›è¡Œè®²è§£</p> <h2 id="æµç¨‹"><a href="#æµç¨‹" class="header-anchor">#</a> æµç¨‹</h2> <ol><li>ç”¨æˆ·è¯·æ±‚ä½ çš„æœåŠ¡å™¨æŸä¸ªè·¯ç”±æ¯”å¦‚/login</li> <li>æœåŠ¡ç«¯redirectæµè§ˆå™¨åˆ°æˆæƒé¡µ
<code>https://github.com/login/oauth/authorize?response_type=code&amp;client_id=&amp;redirect_url=domain/login/github/callback&amp;state=</code></li> <li>ç”¨æˆ·åœ¨æˆæƒé¡µå®Œæˆæˆæƒ</li> <li>githubè¯·æ±‚2å‚æ•°é‡Œçš„redirect_urlï¼Œå‚æ•°é‡Œå¸¦ç€codeå’Œstate</li> <li>æœåŠ¡ç«¯å¤„ç†è¯·æ±‚ï¼Œé€šè¿‡stateæ£€æµ‹è¯·æ±‚æœ‰æ•ˆæ€§ï¼Œç„¶åè¯·æ±‚github access_token
<code>POST https://github.com/login/oauth/access_token</code></li> <li>æ‹¿åˆ°access_tokenåå°±å¯ä»¥è¯·æ±‚apiè·å–ç”¨æˆ·ä¿¡æ¯
Authorization: token OAUTH-TOKEN
<code>GET https://api.github.com/user</code></li> <li>ç„¶åæœåŠ¡ç«¯å¯ä»¥è¿›è¡Œredirectæµè§ˆå™¨åˆ°ç™»å½•æˆåŠŸé¡µï¼Œè®¾ç½®cookieç­‰æ“ä½œ</li></ol> <h2 id="ç¬¬ä¸‰æ–¹åº“"><a href="#ç¬¬ä¸‰æ–¹åº“" class="header-anchor">#</a> ç¬¬ä¸‰æ–¹åº“</h2> <p>æˆ‘ç”¨çš„æ˜¯<code>fastify-oauth</code>,è¿™ä¸ªæ’ä»¶åšäº†ä¸€äº›åŸºæœ¬é…ç½®çš„äº‹ï¼Œè¿˜æœ‰2ï¼Œæä¾›äº†5çš„apiã€‚å› ä¸ºæƒ³åœ¨ç™»å½•æˆåŠŸåè·³è½¬åˆ°åŸå§‹ç™»å½•é¡µurlé‡Œredirect_toæŒ‡å®šçš„é¡µé¢ï¼Œæ²¡æ‰¾åˆ°è¿™ä¸ªæ’ä»¶æœ‰æä¾›è¿™ä¸ªåŸå§‹urlï¼Œå°±æäº†ä¸ªissueã€‚å› ä¸ºä¸Šæ¬¡æissueæ²¡å¾—åˆ°åé¦ˆï¼Œè¿™æ¬¡æè¿°å†™çš„å¾ˆç®€ç•¥ï¼Œç»“æœæ„å¤–çš„å¾ˆå¿«å°±å¾—åˆ°äº†å›å¤ï¼Œè€Œä¸”ç­”å¤è€…å¾ˆå¿«ç»™å‡ºäº†æ‹¦æˆªåˆå§‹è¯·æ±‚è‡ªå®šä¹‰stateçš„æ–¹æ¡ˆï¼Œæœ€åé—®é¢˜å®Œç¾è§£å†³ğŸ‰ï¼Œè¯¦æƒ…å‚è§<a href="https://github.com/fastify/fastify-oauth2/issues/121" target="_blank" rel="noopener noreferrer">https://github.com/fastify/fastify-oauth2/issues/121<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="ä¸€äº›é—®é¢˜"><a href="#ä¸€äº›é—®é¢˜" class="header-anchor">#</a> ä¸€äº›é—®é¢˜</h2> <h3 id="referer-policy"><a href="#referer-policy" class="header-anchor">#</a> referer policy</h3> <p>æœ¬åœ°æµ‹è¯•çš„æ—¶å€™å› ä¸ºå‰åç«¯æ˜¯ä¸åŒç«¯å£ï¼Œ/login/githubè¯·æ±‚çš„headeré‡Œçš„refererå¹¶æ²¡æœ‰å¸¦querystringéƒ¨åˆ†ï¼ŒåŸå› æ˜¯referer policy</p> <blockquote><p>Since version 85 of Chrome, the referrer policy has changed for privacy reasons. If a site doesnâ€™t define its own policy, then the default one applied by the browser will be strict-origin-when-cross-origin.</p> <p>With this policy, only the origin is sent in the Referer header of cross-origin requests. In order words, when our hit is fired, it is sent to our collection domain which is different from the domain of the site. In that case, only the main domain is set in the Referrer and the query string is lost</p></blockquote> <h3 id="set-cookie"><a href="#set-cookie" class="header-anchor">#</a> Set-Cookie</h3> <p>ç¬¬ä¸€æ¬¡set-cookieæ²¡åŠ path=/, é»˜è®¤çš„cookie pathæ˜¯è¯·æ±‚çš„å½“å‰è·¯å¾„å³/login/github/callback, ç™»å½•åredirectæŒ‡å®šé¡µåcookieæ²¡äº†</p> <h3 id="github-timeout"><a href="#github-timeout" class="header-anchor">#</a> github timeout</h3> <p>æˆæƒæˆåŠŸå/login/github/callbackæ¥å£504äº†ï¼Œæ€€ç–‘æ˜¯è®¿é—®githubæ¥å£é—®é¢˜ï¼Œæœç„¶åœ¨æœåŠ¡å™¨ä¸Šping github.comä¸é€šï¼Œå‚è€ƒ[^1]ç¼–è¾‘/etc/hostsæ–‡ä»¶</p> <div class="language-plain extra-class"><pre class="language-plain"><code>140.82.114.3 github.com
199.232.69.194 github.global.ssl.fastly.net
</code></pre></div><p>èƒ½pingé€šäº†ï¼Œsslè®¿é—®è¿˜æ˜¯ä¸é€šğŸ˜ã€‚</p> <h2 id="æœ€ç»ˆä»£ç "><a href="#æœ€ç»ˆä»£ç " class="header-anchor">#</a> æœ€ç»ˆä»£ç </h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> defaultState <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
fastify<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>oauthPlugin<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'githubOAuth2'</span><span class="token punctuation">,</span>
  credentials<span class="token operator">:</span> <span class="token punctuation">{</span>
    client<span class="token operator">:</span> <span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      secret<span class="token operator">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    auth<span class="token operator">:</span> oauthPlugin<span class="token punctuation">.</span><span class="token constant">GITHUB_CONFIGURATION</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  startRedirectPath<span class="token operator">:</span> <span class="token string">'/login/github'</span><span class="token punctuation">,</span>
  callbackUri<span class="token operator">:</span> <span class="token string">'http://&lt;domain&gt;/api/login/github/callback'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">generateStateFunction</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> redirectUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'referer'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_to'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>redirectUrl<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>defaultState<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> state
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">checkStateFunction</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">returnedState<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>returnedState<span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'ascii'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>defaultState <span class="token operator">==</span> defaultState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Invalid state'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>fastify<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/login/github/callback'</span><span class="token punctuation">,</span> opts<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> reply</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> redirectUrl <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>query<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'ascii'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>redirectUrl <span class="token operator">||</span> <span class="token string">'/'</span>
  <span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token keyword">await</span> fastify<span class="token punctuation">.</span>githubOAuth2<span class="token punctuation">.</span><span class="token function">getAccessTokenFromAuthorizationCodeFlow</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
  <span class="token keyword">const</span> userinfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">got</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">'Authorization'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">token </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> oauthUser <span class="token operator">=</span> <span class="token keyword">await</span> fastify<span class="token punctuation">.</span>prisma<span class="token punctuation">.</span>oauthUser<span class="token punctuation">.</span><span class="token function">findUnique</span><span class="token punctuation">(</span><span class="token punctuation">{</span>where<span class="token operator">:</span> <span class="token punctuation">{</span>provider_uid<span class="token operator">:</span> <span class="token punctuation">{</span>provider<span class="token operator">:</span> <span class="token string">'github'</span><span class="token punctuation">,</span> uid<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>userinfo<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>oauthUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> fastify<span class="token punctuation">.</span>prisma<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token punctuation">{</span> loginName<span class="token operator">:</span> <span class="token string">'random'</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token keyword">await</span> fastify<span class="token punctuation">.</span>bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string">'random'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    oauthUser <span class="token operator">=</span> <span class="token keyword">await</span> fastify<span class="token punctuation">.</span>prisma<span class="token punctuation">.</span>oauthUser<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>uid<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>userinfo<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> provider<span class="token operator">:</span> <span class="token string">'github'</span><span class="token punctuation">,</span> userId<span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> specials<span class="token operator">:</span> userinfo<span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  token <span class="token operator">=</span> fastify<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> oauthUser<span class="token punctuation">.</span>userId <span class="token punctuation">}</span><span class="token punctuation">)</span>
  reply<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; expires=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">7</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUTCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; path=/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  reply<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>redirectUrl<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="header-anchor">#</a> å‚è€ƒ</h2> <ul><li><a href="https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps" target="_blank" rel="noopener noreferrer">github-oauth<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://auth0.com/docs/configure/attack-protection/state-parameters#use-the-stored-url-to-redirect-users" target="_blank" rel="noopener noreferrer">use-the-stored-url-to-redirect-users<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://helpcentre.atinternet-solutions.com/hc/en-gb/articles/360017026680-Why-aren-t-my-query-string-parameters-retrieved-" target="_blank" rel="noopener noreferrer">Why-aren-t-my-query-string-parameters-retrieved<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>[^1]: <a href="https://zhuanlan.zhihu.com/p/314071453" target="_blank" rel="noopener noreferrer">æé«˜å›½å†…è®¿é—® github é€Ÿåº¦çš„ 9 ç§æ–¹æ³•<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#ç®€ä»‹" title="ç®€ä»‹">ç®€ä»‹</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#æµç¨‹" title="æµç¨‹">æµç¨‹</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#ç¬¬ä¸‰æ–¹åº“" title="ç¬¬ä¸‰æ–¹åº“">ç¬¬ä¸‰æ–¹åº“</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#ä¸€äº›é—®é¢˜" title="ä¸€äº›é—®é¢˜">ä¸€äº›é—®é¢˜</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#referer-policy" title="referer policy">referer policy</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#set-cookie" title="Set-Cookie">Set-Cookie</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#github-timeout" title="github timeout">github timeout</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#æœ€ç»ˆä»£ç " title="æœ€ç»ˆä»£ç ">æœ€ç»ˆä»£ç </a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#å‚è€ƒ" title="å‚è€ƒ">å‚è€ƒ</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/iamtmoe" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8>Privacy Policy</a></li><li class="copyright-item" data-v-3d9deeb8>MIT Licensed | Copyright Â© ä¸€ä½•æœ‰å°”</li></ul></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.c616dceb.js" defer></script><script src="/blog/assets/js/6.b5d332af.js" defer></script><script src="/blog/assets/js/3.749e8baa.js" defer></script><script src="/blog/assets/js/21.84e35001.js" defer></script><script src="/blog/assets/js/8.050f5748.js" defer></script>
  </body>
</html>
