<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nuxt简介 | 一何有尔的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="shortcut icon" href="/blog/favicon.ico">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/app_icon/app_icon48.jpeg">
    <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="
服务端渲染方案

what

在服务端生成html静态字符串，发送到客户端，再混合成可交互的app

SSR架构

why

减少首屏时间
SEO

缺点

开发限制
更多的构建部署要求
加大服务器负载

参考链接

[vue ssr guide](https://ssr.v ...">
    <meta name="baidu-site-verification" content="41GlPEeYTk">
    <meta name="keywords" content="vuepress, blog, 一何有尔">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/images/app_icon/app_icon48.jpeg">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.db20579b.css" as="style"><link rel="preload" href="/blog/assets/js/app.c616dceb.js" as="script"><link rel="preload" href="/blog/assets/js/6.b5d332af.js" as="script"><link rel="preload" href="/blog/assets/js/3.749e8baa.js" as="script"><link rel="preload" href="/blog/assets/js/12.bca8c580.js" as="script"><link rel="preload" href="/blog/assets/js/8.050f5748.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.aa1dac21.js"><link rel="prefetch" href="/blog/assets/js/11.70c977ba.js"><link rel="prefetch" href="/blog/assets/js/13.b618ec97.js"><link rel="prefetch" href="/blog/assets/js/14.80ae0e92.js"><link rel="prefetch" href="/blog/assets/js/15.1e8d5c02.js"><link rel="prefetch" href="/blog/assets/js/16.9fcef108.js"><link rel="prefetch" href="/blog/assets/js/17.60290ab1.js"><link rel="prefetch" href="/blog/assets/js/18.bd9b53f4.js"><link rel="prefetch" href="/blog/assets/js/19.bf170d35.js"><link rel="prefetch" href="/blog/assets/js/20.76d2073a.js"><link rel="prefetch" href="/blog/assets/js/21.84e35001.js"><link rel="prefetch" href="/blog/assets/js/22.9a77eca9.js"><link rel="prefetch" href="/blog/assets/js/23.eee85973.js"><link rel="prefetch" href="/blog/assets/js/24.af56bcfb.js"><link rel="prefetch" href="/blog/assets/js/25.b9c14c5d.js"><link rel="prefetch" href="/blog/assets/js/26.31632e5f.js"><link rel="prefetch" href="/blog/assets/js/27.b62c171d.js"><link rel="prefetch" href="/blog/assets/js/28.c6fdb267.js"><link rel="prefetch" href="/blog/assets/js/29.c3073e06.js"><link rel="prefetch" href="/blog/assets/js/30.8fd564e6.js"><link rel="prefetch" href="/blog/assets/js/31.2d770bc9.js"><link rel="prefetch" href="/blog/assets/js/32.a63a63d2.js"><link rel="prefetch" href="/blog/assets/js/33.8bc5dfef.js"><link rel="prefetch" href="/blog/assets/js/34.768a88f4.js"><link rel="prefetch" href="/blog/assets/js/35.07c0faed.js"><link rel="prefetch" href="/blog/assets/js/36.91bb844e.js"><link rel="prefetch" href="/blog/assets/js/4.c95f156b.js"><link rel="prefetch" href="/blog/assets/js/5.1b5f68e5.js"><link rel="prefetch" href="/blog/assets/js/7.833de25a.js"><link rel="prefetch" href="/blog/assets/js/9.5e1c757e.js"><link rel="prefetch" href="/blog/assets/js/vuejs-paginate.c4247c5c.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.db20579b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/blog/" class="nav-link home-link">一何有尔的博客 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/blog/" class="nav-link">Home</a></li><li class="nav-item"><a href="/blog/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/blog/" class="nav-link mobile-home-link">一何有尔的博客 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/blog/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/blog/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="1970-01-01T00:00:00.000Z">
      Thu Jan 01 1970
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/blog/tag/nuxt" data-v-42ccfcd5><span data-v-42ccfcd5>nuxt</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h1 id="nuxt简介"><a href="#nuxt简介" class="header-anchor">#</a> nuxt简介</h1> <h2 id="服务端渲染方案"><a href="#服务端渲染方案" class="header-anchor">#</a> 服务端渲染方案</h2> <h3 id="what"><a href="#what" class="header-anchor">#</a> what</h3> <p>在服务端生成html静态字符串，发送到客户端，再混合成可交互的app</p> <p><img src="/blog/assets/img/ssr-architect.08daea42.png" alt="SSR架构"></p> <h3 id="why"><a href="#why" class="header-anchor">#</a> why</h3> <ul><li>减少首屏时间</li> <li>SEO</li></ul> <h3 id="缺点"><a href="#缺点" class="header-anchor">#</a> 缺点</h3> <ul><li>开发限制</li> <li>更多的构建部署要求</li> <li>加大服务器负载</li></ul> <p>参考链接</p> <ol><li><a href="https://ssr.vuejs.org/" target="_blank" rel="noopener noreferrer">vue ssr guide<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/vuejs/vue-hackernews-2.0/" target="_blank" rel="noopener noreferrer">vue ssr demo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <h2 id="dev-主流程"><a href="#dev-主流程" class="header-anchor">#</a> dev 主流程</h2> <h3 id="构建时"><a href="#构建时" class="header-anchor">#</a> 构建时</h3> <ul><li>getNuxtConfig获取配置，优先级是命令行参数 &gt; 配置文件 &gt; 默认配置</li> <li>getNuxt获取Nuxt实例</li> <li>setup hooks，Nuxt继承自<a href="https://www.npmjs.com/package/hable" target="_blank" rel="noopener noreferrer">hable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>初始化nuxt,其中包括初始化moduleContainer和server</li> <li>启动server listeners</li> <li>控制台打印listeners启动消息</li> <li>浏览器自动打开页面（可选）</li> <li>获取builder实例并构建</li> <li>控制台打印内存使用</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/cli/src/commands/dev.js</span>
<span class="token keyword">async</span> <span class="token function">_startDev</span> <span class="token punctuation">(</span><span class="token parameter">cmd<span class="token punctuation">,</span> argv</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> cmd<span class="token punctuation">.</span><span class="token function">getNuxtConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dev<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> _build<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> nuxt <span class="token operator">=</span> <span class="token keyword">await</span> cmd<span class="token punctuation">.</span><span class="token function">getNuxt</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>

    <span class="token comment">// Setup hooks</span>
    nuxt<span class="token punctuation">.</span><span class="token function">hook</span><span class="token punctuation">(</span><span class="token string">'watch:restart'</span><span class="token punctuation">,</span> <span class="token parameter">payload</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onWatchRestart</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token punctuation">{</span> nuxt<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> argv <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    nuxt<span class="token punctuation">.</span><span class="token function">hook</span><span class="token punctuation">(</span><span class="token string">'bundler:change'</span><span class="token punctuation">,</span> <span class="token parameter">changedFileName</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onBundlerChange</span><span class="token punctuation">(</span>changedFileName<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// Wait for nuxt to be ready</span>
    <span class="token keyword">await</span> nuxt<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Start listening</span>
    <span class="token keyword">await</span> nuxt<span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Show banner when listening</span>
    <span class="token function">showBanner</span><span class="token punctuation">(</span>nuxt<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

    <span class="token comment">// Opens the server listeners url in the default browser (only once)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">.</span>open<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      argv<span class="token punctuation">.</span>open <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token keyword">const</span> openerPromises <span class="token operator">=</span> nuxt<span class="token punctuation">.</span>server<span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">listener</span> <span class="token operator">=&gt;</span> <span class="token function">opener</span><span class="token punctuation">(</span>listener<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>openerPromises<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Create builder instance</span>
    <span class="token keyword">const</span> builder <span class="token operator">=</span> <span class="token keyword">await</span> cmd<span class="token punctuation">.</span><span class="token function">getBuilder</span><span class="token punctuation">(</span>nuxt<span class="token punctuation">)</span>

    <span class="token comment">// Start Build</span>
    <span class="token keyword">await</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Print memory usage</span>
    <span class="token function">showMemoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Return instance</span>
    <span class="token keyword">return</span> nuxt
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><ul><li>初始化nuxt,其中包括初始化moduleContainer和server</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/core/src/nuxt.js</span>
<span class="token keyword">async</span> <span class="token function">_init</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_initCalled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_initCalled <span class="token operator">=</span> <span class="token boolean">true</span>

    <span class="token comment">// Add hooks</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>hooks<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addHooks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>hooks<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>hooks <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">hooks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hook<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Await for modules</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>moduleContainer<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Await for server to be ready</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Call ready hook</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>moduleContainer顺序加载buildModules和modules</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/core/src/module.js</span>
<span class="token keyword">async</span> <span class="token function">ready</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Call before hook</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'modules:before'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>modules<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>buildModules <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>_start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Load every devModule in sequence</span>
      <span class="token keyword">await</span> <span class="token function">sequence</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>buildModules<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addModule</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Load every module in sequence</span>
    <span class="token keyword">await</span> <span class="token function">sequence</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addModule</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// Call done hook</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'modules:done'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

</code></pre></div><ul><li>server.ready主要做是注册中间件，在此之前要初始化vueRenderer</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/server/src/server.js</span>
<span class="token keyword">async</span> <span class="token function">ready</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serverContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRenderer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverContext<span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// Setup nuxt middleware</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>vue-renderer的初始化主要做一件事：加载资源</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/vue-renderer/src/renderer.js</span>
<span class="token keyword">async</span> <span class="token function">_ready</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Resolve dist path</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>distPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>buildDir<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'server'</span><span class="token punctuation">)</span>

    <span class="token comment">// -- Development mode --</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>serverContext<span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span><span class="token function">hook</span><span class="token punctuation">(</span><span class="token string">'build:resources'</span><span class="token punctuation">,</span> <span class="token parameter">mfs</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadResources</span><span class="token punctuation">(</span>mfs<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// -- Production mode --</span>

    <span class="token comment">// Try once to load SSR resources from fs</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadResources</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>http.createServer(app).listen()</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/server/src/listener.js</span>
<span class="token keyword">async</span> <span class="token function">listen</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// Initialize underlying http(s) server</span>
    <span class="token keyword">const</span> protocol <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>https <span class="token operator">?</span> https <span class="token operator">:</span> http
    <span class="token keyword">const</span> protocolOpts <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>https <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>https<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_server <span class="token operator">=</span> protocol<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>protocol<span class="token punctuation">,</span> protocolOpts<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// Call server.listen</span>
    <span class="token comment">// Prepare listenArgs</span>
    <span class="token keyword">const</span> listenArgs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socket <span class="token operator">?</span> <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socket <span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token punctuation">{</span> host<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>host<span class="token punctuation">,</span> port<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token punctuation">}</span>
    listenArgs<span class="token punctuation">.</span>exclusive <span class="token operator">=</span> <span class="token boolean">false</span>

    <span class="token comment">// Call server.listen</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>server <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>listenArgs<span class="token punctuation">,</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> error <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">serverErrorHandler</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>获取buider实例并构建, 主要做的事情是：
<ul><li>创建.nuxt目录和components子目录，生产环境的话会创建dist/server, dist/client子目录</li> <li>解析layouts目录，填充<code>templateVars.layouts</code></li> <li>解析pages目录，填充 <code>templateVars.router.routes</code></li> <li>解析store目录，填充<code>templateVars.storeModules</code></li> <li>解析middleware目录，填充<code>templateVars.middleware</code></li> <li>添加可选模版文件<code>nuxt-build-indicator.vue</code>和<code>nuxt-loading.vue</code></li> <li>添加自定义模版文件到templateFiles,</li> <li>添加loading.html到templateFiles,</li> <li>编译模版并输出编译后的文件到.nuxt目录</li> <li>处理插件</li> <li>webpack打包</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/builder/src/builder.js</span>
<span class="token keyword">async</span> <span class="token function">build</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// Call before hook</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'build:before'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>build<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// Create .nuxt/, .nuxt/components and .nuxt/dist folders</span>
    <span class="token keyword">await</span> fsExtra<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token function">r</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>buildDir<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> buildDirs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">r</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>buildDir<span class="token punctuation">,</span> <span class="token string">'components'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      buildDirs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
        <span class="token function">r</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>buildDir<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'client'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">r</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>buildDir<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'server'</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>buildDirs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">dir</span> <span class="token operator">=&gt;</span> fsExtra<span class="token punctuation">.</span><span class="token function">mkdirp</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// Call ready hook</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'builder:prepared'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>build<span class="token punctuation">)</span>

    <span class="token comment">// Generate routes and interpret the template files</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateRoutesAndFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Start bundle build: webpack, rollup, parcel...</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bundleBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Flag to set that building is done</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_buildStatus <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">BUILD_DONE</span>

    <span class="token comment">// Call done hook</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'build:done'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/builder/src/builder.js</span>
<span class="token keyword">async</span> <span class="token function">generateRoutesAndFiles</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    consola<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Generating nuxt files'</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bundleBuilder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>bundleBuilder<span class="token punctuation">.</span><span class="token function">pauseWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>plugins <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">normalizePlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> templateContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createTemplateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveLayouts</span><span class="token punctuation">(</span>templateContext<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveRoutes</span><span class="token punctuation">(</span>templateContext<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveStore</span><span class="token punctuation">(</span>templateContext<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveMiddleware</span><span class="token punctuation">(</span>templateContext<span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addOptionalTemplates</span><span class="token punctuation">(</span>templateContext<span class="token punctuation">)</span>

    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveCustomTemplates</span><span class="token punctuation">(</span>templateContext<span class="token punctuation">)</span>

    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveLoadingIndicator</span><span class="token punctuation">(</span>templateContext<span class="token punctuation">)</span>

    <span class="token comment">// Add vue-app template dir to watchers</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>build<span class="token punctuation">.</span>watch<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">globPathWithExtensions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>template<span class="token punctuation">.</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileTemplates</span><span class="token punctuation">(</span>templateContext<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bundleBuilder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>bundleBuilder<span class="token punctuation">.</span><span class="token function">resumeWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    consola<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'Nuxt files generated'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>模版是指在文件中嵌入变量， vue-app包的模版目录存放默认的模版文件，用模版变量编译生成最终需要的文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/builder/src/context/template.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">TemplateContext</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">builder<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>templateFiles <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>template<span class="token punctuation">.</span>files<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>templateVars <span class="token operator">=</span> <span class="token punctuation">{</span>
      nuxtOptions<span class="token operator">:</span> options<span class="token punctuation">,</span>
      features<span class="token operator">:</span> options<span class="token punctuation">.</span>features<span class="token punctuation">,</span>
      extensions<span class="token operator">:</span> options<span class="token punctuation">.</span>extensions
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">ext</span> <span class="token operator">=&gt;</span> ext<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\.</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      messages<span class="token operator">:</span> options<span class="token punctuation">.</span>messages<span class="token punctuation">,</span>
      splitChunks<span class="token operator">:</span> options<span class="token punctuation">.</span>build<span class="token punctuation">.</span>splitChunks<span class="token punctuation">,</span>
      uniqBy<span class="token punctuation">,</span>
      isDev<span class="token operator">:</span> options<span class="token punctuation">.</span>dev<span class="token punctuation">,</span>
      isTest<span class="token operator">:</span> options<span class="token punctuation">.</span>test<span class="token punctuation">,</span>
      debug<span class="token operator">:</span> options<span class="token punctuation">.</span>debug<span class="token punctuation">,</span>
      buildIndicator<span class="token operator">:</span> options<span class="token punctuation">.</span>dev <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>build<span class="token punctuation">.</span>indicator<span class="token punctuation">,</span>
      vue<span class="token operator">:</span> <span class="token punctuation">{</span> config<span class="token operator">:</span> options<span class="token punctuation">.</span>vue<span class="token punctuation">.</span>config <span class="token punctuation">}</span><span class="token punctuation">,</span>
      fetch<span class="token operator">:</span> options<span class="token punctuation">.</span>fetch<span class="token punctuation">,</span>
      mode<span class="token operator">:</span> options<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
      router<span class="token operator">:</span> options<span class="token punctuation">.</span>router<span class="token punctuation">,</span>
      env<span class="token operator">:</span> options<span class="token punctuation">.</span>env<span class="token punctuation">,</span>
      head<span class="token operator">:</span> options<span class="token punctuation">.</span>head<span class="token punctuation">,</span>
      store<span class="token operator">:</span> options<span class="token punctuation">.</span>features<span class="token punctuation">.</span>store <span class="token operator">?</span> options<span class="token punctuation">.</span>store <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      globalName<span class="token operator">:</span> options<span class="token punctuation">.</span>globalName<span class="token punctuation">,</span>
      globals<span class="token operator">:</span> builder<span class="token punctuation">.</span>globals<span class="token punctuation">,</span>
      css<span class="token operator">:</span> options<span class="token punctuation">.</span>css<span class="token punctuation">,</span>
      plugins<span class="token operator">:</span> builder<span class="token punctuation">.</span>plugins<span class="token punctuation">,</span>
      appPath<span class="token operator">:</span> <span class="token string">'./App.js'</span><span class="token punctuation">,</span>
      layouts<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>layouts<span class="token punctuation">)</span><span class="token punctuation">,</span>
      loading<span class="token operator">:</span>
        <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>loading <span class="token operator">===</span> <span class="token string">'string'</span>
          <span class="token operator">?</span> builder<span class="token punctuation">.</span><span class="token function">relativeToBuild</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>srcDir<span class="token punctuation">,</span> options<span class="token punctuation">.</span>loading<span class="token punctuation">)</span>
          <span class="token operator">:</span> options<span class="token punctuation">.</span>loading<span class="token punctuation">,</span>
      pageTransition<span class="token operator">:</span> options<span class="token punctuation">.</span>pageTransition<span class="token punctuation">,</span>
      layoutTransition<span class="token operator">:</span> options<span class="token punctuation">.</span>layoutTransition<span class="token punctuation">,</span>
      rootDir<span class="token operator">:</span> options<span class="token punctuation">.</span>rootDir<span class="token punctuation">,</span>
      srcDir<span class="token operator">:</span> options<span class="token punctuation">.</span>srcDir<span class="token punctuation">,</span>
      dir<span class="token operator">:</span> options<span class="token punctuation">.</span>dir<span class="token punctuation">,</span>
      components<span class="token operator">:</span> <span class="token punctuation">{</span>
        ErrorPage<span class="token operator">:</span> options<span class="token punctuation">.</span>ErrorPage
          <span class="token operator">?</span> builder<span class="token punctuation">.</span><span class="token function">relativeToBuild</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>ErrorPage<span class="token punctuation">)</span>
          <span class="token operator">:</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>默认模版文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/vue-app/src/index.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token punctuation">{</span>
  dependencies<span class="token punctuation">,</span>
  dir<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'template'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  files<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'App.js'</span><span class="token punctuation">,</span>
    <span class="token string">'client.js'</span><span class="token punctuation">,</span>
    <span class="token string">'index.js'</span><span class="token punctuation">,</span>
    <span class="token string">'router.js'</span><span class="token punctuation">,</span>
    <span class="token string">'router.scrollBehavior.js'</span><span class="token punctuation">,</span>
    <span class="token string">'server.js'</span><span class="token punctuation">,</span>
    <span class="token string">'utils.js'</span><span class="token punctuation">,</span>
    <span class="token string">'empty.js'</span><span class="token punctuation">,</span>
    <span class="token string">'components/nuxt-error.vue'</span><span class="token punctuation">,</span>
    <span class="token string">'components/nuxt-child.js'</span><span class="token punctuation">,</span>
    <span class="token string">'components/nuxt-link.server.js'</span><span class="token punctuation">,</span>
    <span class="token string">'components/nuxt-link.client.js'</span><span class="token punctuation">,</span>
    <span class="token string">'components/nuxt.js'</span><span class="token punctuation">,</span>
    <span class="token string">'views/app.template.html'</span><span class="token punctuation">,</span>
    <span class="token string">'views/error.html'</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>this.bundleBuilder.build()是调用webpack来构建, entry为<code>.nuxt/server.js</code>, 使用<code>VueSSRServerPlugin</code>输出<code>server.manifest.json</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/webpack/src/builder.js</span>
<span class="token keyword">async</span> <span class="token function">build</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> options <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buildContext

    <span class="token keyword">const</span> webpackConfigs <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getWebpackConfig</span><span class="token punctuation">(</span><span class="token string">'Client'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>modern<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        webpackConfigs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getWebpackConfig</span><span class="token punctuation">(</span><span class="token string">'Modern'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>build<span class="token punctuation">.</span>ssr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        webpackConfigs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getWebpackConfig</span><span class="token punctuation">(</span><span class="token string">'Server'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buildContext<span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'webpack:config'</span><span class="token punctuation">,</span> webpackConfigs<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// Configure compilers</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>compilers <span class="token operator">=</span> webpackConfigs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>

        <span class="token comment">// In dev, write files in memory FS</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compiler<span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mfs
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> compiler
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// ...</span>

    <span class="token comment">// Start Builds</span>
    <span class="token keyword">const</span> runner <span class="token operator">=</span> options<span class="token punctuation">.</span>dev <span class="token operator">?</span> parallel <span class="token operator">:</span> sequence

    <span class="token keyword">await</span> <span class="token function">runner</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>compilers<span class="token punctuation">,</span> <span class="token parameter">compiler</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">webpackCompile</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>利用<a href="https://github.com/webpack/tapable" target="_blank" rel="noopener noreferrer">tapable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>在done钩子里调用nuxt加载资源的钩子</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/webpack/src/builder.js</span>
 <span class="token keyword">async</span> <span class="token function">webpackCompile</span> <span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> compiler<span class="token punctuation">.</span>options
    <span class="token keyword">const</span> <span class="token punctuation">{</span> nuxt<span class="token punctuation">,</span> options <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buildContext

    <span class="token keyword">await</span> nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'build:compile'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> compiler <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// Load renderer resources after build</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'load-resources'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'build:compiled'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        name<span class="token punctuation">,</span>
        compiler<span class="token punctuation">,</span>
        stats
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">// Reload renderer</span>
      <span class="token keyword">await</span> nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'build:resources'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mfs<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// --- Dev Build ---</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Client Build, watch is started by dev-middleware</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'client'</span><span class="token punctuation">,</span> <span class="token string">'modern'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'nuxt-dev'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">webpackDev</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Server, build and watch for changes</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> watching <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>watchers<span class="token punctuation">.</span>webpack<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          watching<span class="token punctuation">.</span>close <span class="token operator">=</span> <span class="token function">pify</span><span class="token punctuation">(</span>watching<span class="token punctuation">.</span>close<span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>compilersWatching<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watching<span class="token punctuation">)</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// --- Production Build ---</span>
    compiler<span class="token punctuation">.</span>run <span class="token operator">=</span> <span class="token function">pify</span><span class="token punctuation">(</span>compiler<span class="token punctuation">.</span>run<span class="token punctuation">)</span>
    <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// non-quiet mode: errors will be printed by webpack itself</span>
      <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Nuxt build error'</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>build<span class="token punctuation">.</span>quiet <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        error<span class="token punctuation">.</span>stack <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'errors-only'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">throw</span> error
    <span class="token punctuation">}</span>

    <span class="token comment">// Await for renderer to load resources (programmatic, tests and generate)</span>
    <span class="token keyword">await</span> nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'build:resources'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>同样利用hable钩子注册dev环境server运行时中间件：<a href="https://www.npmjs.com/package/webpack-dev-middleware" target="_blank" rel="noopener noreferrer">webpack-dev-middleware<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://www.npmjs.com/package/webpack-hot-middleware" target="_blank" rel="noopener noreferrer">webpack-hot-middleware<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/webpack/src/builder.js</span>
  <span class="token keyword">async</span> <span class="token function">webpackDev</span> <span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    consola<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Creating webpack middleware...'</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> compiler<span class="token punctuation">.</span>options
    <span class="token keyword">const</span> buildOptions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buildContext<span class="token punctuation">.</span>options<span class="token punctuation">.</span>build
    <span class="token keyword">const</span> <span class="token punctuation">{</span> client<span class="token punctuation">,</span> <span class="token operator">...</span>hotMiddlewareOptions <span class="token punctuation">}</span> <span class="token operator">=</span> buildOptions<span class="token punctuation">.</span>hotMiddleware <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">// Create webpack dev middleware</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>devMiddleware<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">pify</span><span class="token punctuation">(</span>
      <span class="token function">webpackDevMiddleware</span><span class="token punctuation">(</span>
        compiler<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          publicPath<span class="token operator">:</span> buildOptions<span class="token punctuation">.</span>publicPath<span class="token punctuation">,</span>
          stats<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          logLevel<span class="token operator">:</span> <span class="token string">'silent'</span><span class="token punctuation">,</span>
          watchOptions<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buildContext<span class="token punctuation">.</span>options<span class="token punctuation">.</span>watchers<span class="token punctuation">.</span>webpack<span class="token punctuation">,</span>
          <span class="token operator">...</span>buildOptions<span class="token punctuation">.</span>devMiddleware
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>devMiddleware<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>close <span class="token operator">=</span> <span class="token function">pify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>devMiddleware<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>close<span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>compilersWatching<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>devMiddleware<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>watching<span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>hotMiddleware<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">pify</span><span class="token punctuation">(</span>
      <span class="token function">webpackHotMiddleware</span><span class="token punctuation">(</span>
        compiler<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          log<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          heartbeat<span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
          path<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/__webpack_hmr/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          <span class="token operator">...</span>hotMiddlewareOptions
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token comment">// Register devMiddleware on server</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buildContext<span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'server:devMiddleware'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">middleware</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">isModernRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buildContext<span class="token punctuation">.</span>options<span class="token punctuation">.</span>modern<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'modern'</span> <span class="token operator">:</span> <span class="token string">'client'</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>devMiddleware <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>devMiddleware<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>devMiddleware<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hotMiddleware <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hotMiddleware<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hotMiddleware<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>server构造时hook</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// packages/server/src/server.js</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// devMiddleware placeholder</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span><span class="token function">hook</span><span class="token punctuation">(</span><span class="token string">'server:devMiddleware'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">devMiddleware</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>devMiddleware <span class="token operator">=</span> devMiddleware
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="运行时"><a href="#运行时" class="header-anchor">#</a> 运行时</h3> <ul><li>内置connect处理请求会依次执行注册的中间件，最后两个中间件是nuxtMiddleware 和 errorMiddleware, nuxtMiddleware调用vue-renderer 的renderRoute方法完成渲染</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/server/src/server.js</span>
<span class="token keyword">async</span> <span class="token function">setupMiddleware</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Apply setupMiddleware from modules first</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'render:setupMiddleware'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">useMiddleware</span><span class="token punctuation">(</span>compressor<span class="token punctuation">)</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">useMiddleware</span><span class="token punctuation">(</span>staticMiddleware<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// Dev middleware</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">useMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>devMiddleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">devMiddleware</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Add user provided middleware</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> m <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>serverMiddleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">useMiddleware</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// Finally use nuxtMiddleware</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">useMiddleware</span><span class="token punctuation">(</span><span class="token function">nuxtMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span>
      nuxt<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nuxt<span class="token punctuation">,</span>
      renderRoute<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderRoute</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      resources<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resources
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// Apply errorMiddleware from modules first</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'render:errorMiddleware'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span>

    <span class="token comment">// Error middleware for errors that occurred in middleware that declared above</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">useMiddleware</span><span class="token punctuation">(</span><span class="token function">errorMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      resources<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resources<span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>nuxtMiddleware调用renderRoute进行服务端渲染完成响应</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/server/src/middleware/nuxt.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> options<span class="token punctuation">,</span> nuxt<span class="token punctuation">,</span> renderRoute<span class="token punctuation">,</span> resources <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">nuxtMiddleware</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">renderRoute</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token keyword">await</span> nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'render:route'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> result<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      html<span class="token punctuation">,</span>
      cspScriptSrcHashes<span class="token punctuation">,</span>
      error<span class="token punctuation">,</span>
      redirected<span class="token punctuation">,</span>
      preloadFiles
    <span class="token punctuation">}</span> <span class="token operator">=</span> result
    <span class="token comment">// ...</span>
    <span class="token comment">// Send response</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Accept-Ranges'</span><span class="token punctuation">,</span> <span class="token string">'none'</span><span class="token punctuation">)</span> <span class="token comment">// #3870</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Length'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'render:routeDone'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> result<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token keyword">return</span> html
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>renderRoute根据配置的模式调用renderSPA或者renderSSR</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/vue-renderer/src/renderer.js</span>
<span class="token keyword">async</span> <span class="token function">renderRoute</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> renderContext <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> _retried</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Log rendered url</span>
    consola<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Rendering url </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

    <span class="token comment">// Add url to the renderContext</span>
    renderContext<span class="token punctuation">.</span>url <span class="token operator">=</span> url

    <span class="token keyword">const</span> <span class="token punctuation">{</span> req <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> renderContext

    <span class="token comment">// renderContext.spa</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>renderContext<span class="token punctuation">.</span>spa <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO: Remove reading from renderContext.res in Nuxt3</span>
      renderContext<span class="token punctuation">.</span>spa <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">SSR</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>spa <span class="token operator">||</span> <span class="token punctuation">(</span>renderContext<span class="token punctuation">.</span>res <span class="token operator">&amp;&amp;</span> renderContext<span class="token punctuation">.</span>res<span class="token punctuation">.</span>spa<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// renderContext.modern</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>renderContext<span class="token punctuation">.</span>modern <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> modernMode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>modern
      renderContext<span class="token punctuation">.</span>modern <span class="token operator">=</span> modernMode <span class="token operator">===</span> <span class="token string">'client'</span> <span class="token operator">||</span> <span class="token function">isModernRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> modernMode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Call renderContext hook</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverContext<span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'vue-renderer:context'</span><span class="token punctuation">,</span> renderContext<span class="token punctuation">)</span>

    <span class="token comment">// Render SPA or SSR</span>
    <span class="token keyword">return</span> renderContext<span class="token punctuation">.</span>spa
      <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderSPA</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderSSR</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>然后renderSSR调用vue-server-renderer,就是我们一开始介绍的服务端渲染的
一种解决方案</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/vue-renderer/src/renderers/ssr.js</span>
<span class="token keyword">async</span> <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">renderContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// Call Vue renderer renderToString</span>
    <span class="token keyword">let</span> <span class="token constant">APP</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vueRenderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span>

    <span class="token keyword">let</span> <span class="token constant">HEAD</span> <span class="token operator">=</span> <span class="token string">''</span>

    <span class="token comment">// Inject head meta</span>
    <span class="token comment">// (this is unset when features.meta is false in server template)</span>
    <span class="token keyword">const</span> meta <span class="token operator">=</span> renderContext<span class="token punctuation">.</span>meta <span class="token operator">&amp;&amp;</span> renderContext<span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>meta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token constant">HEAD</span> <span class="token operator">+=</span> meta<span class="token punctuation">.</span>title<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
        meta<span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
        meta<span class="token punctuation">.</span>link<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
        meta<span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
        meta<span class="token punctuation">.</span>script<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
        meta<span class="token punctuation">.</span>noscript<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Check if we need to inject scripts and state</span>
    <span class="token keyword">const</span> shouldInjectScripts <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>render<span class="token punctuation">.</span>injectScripts <span class="token operator">!==</span> <span class="token boolean">false</span>

    <span class="token comment">// Add &lt;base href=&quot;&quot;&gt; meta if router base specified</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>_routerBaseSpecified<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token constant">HEAD</span> <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;base href=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>router<span class="token punctuation">.</span>base<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Inject resource hints</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>render<span class="token punctuation">.</span>resourceHints <span class="token operator">&amp;&amp;</span> shouldInjectScripts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token constant">HEAD</span> <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderResourceHints</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Inject styles</span>
    <span class="token constant">HEAD</span> <span class="token operator">+=</span> renderContext<span class="token punctuation">.</span><span class="token function">renderStyles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// Serialize state</span>
    <span class="token keyword">const</span> serializedSession <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">window.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverContext<span class="token punctuation">.</span>globals<span class="token punctuation">.</span>context<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">devalue</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">.</span>nuxt<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldInjectScripts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token constant">APP</span> <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>serializedSession<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/script&gt;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Calculate CSP hashes</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> csp <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>render
    <span class="token keyword">const</span> cspScriptSrcHashes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// Template params</span>
    <span class="token keyword">const</span> templateParams <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token constant">HTML_ATTRS</span><span class="token operator">:</span> meta <span class="token operator">?</span> meta<span class="token punctuation">.</span>htmlAttrs<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment">/* addSrrAttribute */</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token constant">HEAD_ATTRS</span><span class="token operator">:</span> meta <span class="token operator">?</span> meta<span class="token punctuation">.</span>headAttrs<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token constant">BODY_ATTRS</span><span class="token operator">:</span> meta <span class="token operator">?</span> meta<span class="token punctuation">.</span>bodyAttrs<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token constant">HEAD</span><span class="token punctuation">,</span>
      <span class="token constant">APP</span><span class="token punctuation">,</span>
      <span class="token constant">ENV</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>env
    <span class="token punctuation">}</span>

    <span class="token comment">// Call ssr:templateParams hook</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverContext<span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'vue-renderer:ssr:templateParams'</span><span class="token punctuation">,</span> templateParams<span class="token punctuation">)</span>

    <span class="token comment">// Render with SSR template</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderTemplate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverContext<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>ssrTemplate<span class="token punctuation">,</span> templateParams<span class="token punctuation">)</span>

    <span class="token keyword">let</span> preloadFiles
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>render<span class="token punctuation">.</span>http2<span class="token punctuation">.</span>push<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      preloadFiles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPreloadFiles</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      html<span class="token punctuation">,</span>
      cspScriptSrcHashes<span class="token punctuation">,</span>
      preloadFiles<span class="token punctuation">,</span>
      error<span class="token operator">:</span> renderContext<span class="token punctuation">.</span>nuxt<span class="token punctuation">.</span>error<span class="token punctuation">,</span>
      redirected<span class="token operator">:</span> renderContext<span class="token punctuation">.</span>redirected
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>this.vueRenderer.renderToString, 这个vueRenderer的创建</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// packages/vue-renderer/src/renderers/ssr.js</span>
<span class="token function">createRenderer</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create bundle renderer for SSR</span>
    <span class="token keyword">return</span> <span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>serverContext<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>serverManifest<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rendererOptions
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>this.serverContext.resources.serverMinifest和this.serverContext.resources.ssrTemplate分别是构建时输出到dist目录的<code>server.manifest.json</code>和<code>index.ssr.html</code></li></ul> <h2 id="generate"><a href="#generate" class="header-anchor">#</a> generate</h2> <ul><li>预渲染是在构建阶段通过模拟请求对应的路由生成html文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// nuxt.config.js</span>
<span class="token punctuation">{</span>
    mode<span class="token operator">:</span> <span class="token string">'universal'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>npx nuxt generate -m
<span class="token comment"># 或者</span>
<span class="token function">npm</span> run generate -- -m
</code></pre></div><ul><li>为了刷新页面的时候可以请求接口，mounted里面再请求一次，所以导致通过路由链接跳转的时候会请求两次接口，这个问题尚未解决。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">fetch</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> app<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> store <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'FETCH_POSTS'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// if (!this.posts.length) {</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>posts<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// }</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p><img src="/blog/assets/img/nuxt-modern-generate.96d13b03.png" alt="查看网页源代码"></p> <ul><li>type=&quot;module&quot;的脚本给支持es6的浏览器执行，nomodule的脚本给不支持es6的浏览器执行</li></ul></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#服务端渲染方案" title="服务端渲染方案">服务端渲染方案</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#what" title="what">what</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#why" title="why">why</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#缺点" title="缺点">缺点</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#dev-主流程" title="dev 主流程">dev 主流程</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#构建时" title="构建时">构建时</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#运行时" title="运行时">运行时</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#generate" title="generate">generate</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/iamtmoe" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8>Privacy Policy</a></li><li class="copyright-item" data-v-3d9deeb8>MIT Licensed | Copyright © 一何有尔</li></ul></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.c616dceb.js" defer></script><script src="/blog/assets/js/6.b5d332af.js" defer></script><script src="/blog/assets/js/3.749e8baa.js" defer></script><script src="/blog/assets/js/12.bca8c580.js" defer></script><script src="/blog/assets/js/8.050f5748.js" defer></script>
  </body>
</html>
